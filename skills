#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# ///

import curses
import shutil
import sys
from pathlib import Path

REPO_ROOT = Path(__file__).parent.resolve()
SKILLS_SOURCE_DIR = REPO_ROOT / "output_skills"
GLOBAL_SKILLS_DIR = Path.home() / ".claude" / "skills"
LOCAL_SKILLS_DIR = Path.cwd() / ".claude" / "skills"


def discover_skills():
    if not SKILLS_SOURCE_DIR.exists():
        return []
    return sorted([d.name for d in SKILLS_SOURCE_DIR.iterdir() if d.is_dir()])


def is_installed(skill_name):
    source = SKILLS_SOURCE_DIR / skill_name
    target = GLOBAL_SKILLS_DIR / skill_name
    return target.is_symlink() and target.resolve() == source


def is_installed_local(skill_name):
    target = LOCAL_SKILLS_DIR / skill_name
    return target.exists() and target.is_dir()


def install_skill(skill_name):
    source = SKILLS_SOURCE_DIR / skill_name
    target = GLOBAL_SKILLS_DIR / skill_name

    if not source.exists():
        print(f"Error: Skill '{skill_name}' not found in output_skills/")
        return False

    if target.exists() or target.is_symlink():
        if target.is_symlink():
            target.unlink()
        else:
            print(f"Error: {target} exists but is not a symlink. Remove manually.")
            return False

    GLOBAL_SKILLS_DIR.mkdir(parents=True, exist_ok=True)
    target.symlink_to(source)
    return True


def uninstall_skill(skill_name):
    target = GLOBAL_SKILLS_DIR / skill_name
    if target.is_symlink():
        target.unlink()
        return True
    elif target.exists():
        print(f"Error: {target} is not a symlink. Remove manually.")
        return False
    return True


def install_skill_local(skill_name):
    source = SKILLS_SOURCE_DIR / skill_name
    target = LOCAL_SKILLS_DIR / skill_name

    if not source.exists():
        print(f"Error: Skill '{skill_name}' not found in output_skills/")
        return False

    if target.exists():
        shutil.rmtree(target)

    LOCAL_SKILLS_DIR.mkdir(parents=True, exist_ok=True)
    shutil.copytree(source, target)
    return True


def uninstall_skill_local(skill_name):
    target = LOCAL_SKILLS_DIR / skill_name
    if target.exists() and target.is_dir():
        shutil.rmtree(target)
        return True
    elif target.exists():
        print(f"Error: {target} is not a directory. Remove manually.")
        return False
    return True


def cli_status():
    skills = discover_skills()
    if not skills:
        print("No skills found in output_skills/")
        return

    print(f"{'Skill':<20} {'Status'}")
    print("-" * 35)
    for name in skills:
        status = "installed" if is_installed(name) else "not installed"
        print(f"{name:<20} {status}")


def cli_status_local():
    skills = discover_skills()
    if not skills:
        print("No skills found in output_skills/")
        return

    print(f"Local skills ({LOCAL_SKILLS_DIR}):")
    print(f"{'Skill':<20} {'Status'}")
    print("-" * 35)
    for name in skills:
        status = "installed" if is_installed_local(name) else "not installed"
        print(f"{name:<20} {status}")


def cli_install(skill_name):
    if install_skill(skill_name):
        print(f"Installed '{skill_name}' (global)")
    else:
        sys.exit(1)


def cli_uninstall(skill_name):
    if uninstall_skill(skill_name):
        print(f"Uninstalled '{skill_name}' (global)")
    else:
        sys.exit(1)


def cli_install_local(skill_name):
    if install_skill_local(skill_name):
        print(f"Installed '{skill_name}' (local: {LOCAL_SKILLS_DIR})")
    else:
        sys.exit(1)


def cli_uninstall_local(skill_name):
    if uninstall_skill_local(skill_name):
        print(f"Uninstalled '{skill_name}' (local)")
    else:
        sys.exit(1)


def interactive_mode(stdscr):
    curses.curs_set(0)
    curses.use_default_colors()

    skills = discover_skills()

    if not skills:
        stdscr.addstr(0, 0, "No skills found in output_skills/. Press any key to exit.")
        stdscr.getch()
        return

    selected = 0

    while True:
        stdscr.clear()
        stdscr.addstr(0, 0, "Skills Manager (global)")
        stdscr.addstr(1, 0, "─" * 40)

        for i, name in enumerate(skills):
            installed = is_installed(name)
            checkbox = "[x]" if installed else "[ ]"
            prefix = "→ " if i == selected else "  "
            line = f"{prefix}{checkbox} {name}"
            stdscr.addstr(i + 3, 0, line)

        stdscr.addstr(len(skills) + 5, 0, "↑↓ navigate | SPACE toggle | q quit")
        stdscr.refresh()

        key = stdscr.getch()

        if key == ord("q"):
            break
        elif key == curses.KEY_UP and selected > 0:
            selected -= 1
        elif key == curses.KEY_DOWN and selected < len(skills) - 1:
            selected += 1
        elif key == ord(" "):
            name = skills[selected]
            if is_installed(name):
                uninstall_skill(name)
            else:
                install_skill(name)


def print_usage():
    print("Usage:")
    print("  ./skills status              List global skills status")
    print("  ./skills install <name>      Install skill globally (symlink)")
    print("  ./skills uninstall <name>    Uninstall skill globally")
    print("  ./skills toggle              Interactive mode (TUI)")
    print("")
    print("  ./skills local status        List local skills status")
    print("  ./skills local install <name>   Install skill locally (copy)")
    print("  ./skills local uninstall <name> Uninstall skill locally")


def main():
    args = sys.argv[1:]

    if not args:
        print_usage()
    elif args[0] == "status":
        cli_status()
    elif args[0] == "install" and len(args) == 2:
        cli_install(args[1])
    elif args[0] == "uninstall" and len(args) == 2:
        cli_uninstall(args[1])
    elif args[0] == "global" and len(args) >= 2:
        if args[1] == "status":
            cli_status()
        elif args[1] == "install" and len(args) == 3:
            cli_install(args[2])
        elif args[1] == "uninstall" and len(args) == 3:
            cli_uninstall(args[2])
        else:
            print_usage()
            sys.exit(1)
    elif args[0] == "local" and len(args) >= 2:
        if args[1] == "status":
            cli_status_local()
        elif args[1] == "install" and len(args) == 3:
            cli_install_local(args[2])
        elif args[1] == "uninstall" and len(args) == 3:
            cli_uninstall_local(args[2])
        else:
            print_usage()
            sys.exit(1)
    elif args[0] in ("toggle", "on", "off"):
        curses.wrapper(interactive_mode)
    else:
        print_usage()
        sys.exit(1)


if __name__ == "__main__":
    main()
